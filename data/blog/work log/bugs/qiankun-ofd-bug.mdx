---
title: 'è®°ä¸€æ¬¡ qiankun å¼•å‘çš„ bug'
date: '2024-02-09'
# lastmod: '1900-01-01'
tags: ['bug', 'pnpm', 'qiankun']
draft: false
summary: 'qiankun æ˜¯ç›®å‰æœ€å¸¸ç”¨çš„å¾®å‰ç«¯æ¡†æ¶ä¹‹ä¸€, ç¤¾åŒºè¸©è¿‡äº†ä¸å°‘çš„å‘, ç½‘ä¸Šä¹Ÿæœ‰å¾ˆå¤šå¸–å­, ä¿ºä¹Ÿè®°å½•ä¸€ä¸‹æœ¬æ¬¡è¸©åˆ°çš„å°å‘å§, è¿›æ¥çœ‹çœ‹ä½ é‡è§è¿‡æ²¡.'
images: []
layout: PostBanner
---

## Question

æˆ‘ä»¬çš„ä¸šåŠ¡ä¸è´¢ç¨ç›¸å…³, å…¶ä¸­æœ‰ä¸€ä¸ªåŠŸèƒ½ç‚¹æ˜¯å¯¹ `ofd` ç‰ˆå¼æ–‡ä»¶çš„é¢„è§ˆ, ç»å¸¸å¼€å‘ç¥¨çš„äººå¯¹è¿™ä¸ªå¯èƒ½ç†Ÿæ‚‰ç‚¹.
å¯¹æˆ‘æ¥è¯´è¿™æ˜¯ä¸ªæ–°çš„çŸ¥è¯†ç‚¹, æ¯«æ— ç–‘é—®, å’±å…ˆå»ä¸‡èƒ½çš„ github ä¸Šå¯»æ‰¾æ˜¯å¦æœ‰å¼€æºçš„åº“å¯ä»¥é‡‡ç”¨. ç»è¿‡ä¸€ç•ªå¯»æ‰¾å’Œæ¯”å¯¹å, é€‰æ‹©äº† [ofd-tools](https://github.com/zbczbc2006/ofd-tools) è¿™ä¸ªå¼€æºåº“è¿›è¡Œå¼€å‘.

ä¸€åˆ‡éƒ½å¾ˆé¡ºåˆ©, `ofd` æ–‡ä»¶ä¹Ÿèƒ½é¡ºåˆ©æ¸²æŸ“, ä½†å‰ææ˜¯åœ¨ `qiankun` å­åº”ç”¨å•ç‹¬å¯åŠ¨çš„æ—¶å€™, ä¸€æ—¦é€šè¿‡ä¸»åº”ç”¨æ‰“å¼€è¿™ä¸ªé¡µé¢é¢„è§ˆ `ofd` æ–‡ä»¶æ—¶, å°±è«åçš„ç©ºç™½äº†, å•¥ä¹Ÿæ²¡æœ‰, è¿æ§åˆ¶å°çš„æŠ¥é”™ä¿¡æ¯éƒ½æ²¡å¾—, éƒé—·...

## å®šä½

è¿˜èƒ½æ€ä¹ˆåŠ? debug å‘—...

æˆ‘æŠŠ github çš„ä»“åº“å…‹éš†åˆ°æœ¬åœ°, ç„¶åé€šè¿‡ `npm link` çš„æ–¹å¼å»è°ƒè¯•, ç»è¿‡åŠä¸ªå°æ—¶å¤šçš„åŠªåŠ›, æ€»ç®—è®©æˆ‘æ‰¾åˆ°äº†ç½ªé­ç¥¸é¦–!

ä¸€è·¯è·Ÿè¸ªåˆ°äº† `ofd-tools` çš„ä¸€ä¸ªå« `jszip` çš„ä¾èµ–, å…¶ä¸­æœ‰ä¸ªæ–¹æ³•æ˜¯è¿™ä¹ˆå†™çš„:

```js
var onGlobalMessage = function (event) {
    if (
        event.source === global && // ğŸ‘ˆ
        typeof event.data === 'string' &&
        event.data.indexOf(messagePrefix) === 0
    ) {
        runIfPresent(+event.data.slice(messagePrefix.length))
    }
}
```

æœ‰ä¸€ç‚¹ç»éªŒçš„æœ‹å‹åº”è¯¥ä¸€çœ¼å°±èƒ½æ‰«åˆ°é—®é¢˜æ‰€åœ¨äº†å§, å°±æ˜¯ `event.source === global` è¿™é‡Œ, å¦‚æœåœ¨ä¹¾å¤ä¸‹, `global` å§‹ç»ˆéƒ½ä¸ä¼šç­‰äº `event.source`.
ä»¥ä¸º qiankun ä¸‹çš„ `global` æ˜¯è¢« `proxy` åŒ…äº†ä¸€å±‚ä»£ç†çš„, è¿™ä¹Ÿæ˜¯ qiankun çš„æ²™ç®±ç‰¹æ€§[^1]. æ‰¾åˆ°é—®é¢˜æ‰€åœ¨, é‚£å‰©ä¸‹çš„å°±å¥½åŠå•¦.

## è§£å†³

é€šå¸¸ä¿®æ”¹è¿™ç§æºç çš„ bug æœ‰å¾ˆå¤šæ–¹å¼, æ¯”å¦‚ç›´æ¥ç»™åŸä»“åº“æ `pr`, æˆ–è€…ç›´æ¥ä¿®æ”¹æœ¬åœ°çš„ `node_modules` é‡Œçš„ä»£ç ç­‰.

å¤šæ–¹å‡è¡¡ä¹‹ä¸‹, ä½¿ç”¨æ‰“è¡¥ä¸çš„æ–¹å¼å»å¤„ç†æ›´åŠ ç¬¦åˆç°åœ¨çš„é¡¹ç›®æƒ…å†µ. ç”±äºæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯ `pnpm`, ç›´æ¥ä½¿ç”¨ `pnpm patch` å’Œ `pnpm patch-commit` å‘½ä»¤å³å¯å®ç°.
(å¦‚æœä½ ä½¿ç”¨çš„æ˜¯ npm, å¯ä»¥å‚è€ƒ [patch-package](https://www.npmjs.com/package/patch-package)).

1. `pnpm patch jszip@3.10.1`, å¤åˆ¶ä¸€ä¸ªä¸´æ—¶ç›®å½•, å¯ä»¥ä½¿ç”¨ `--edit-dir <dir name>` æŒ‡å®š
2. å»ä¸´æ—¶ç›®å½•ä¸­ä¿®æ”¹æ–‡ä»¶

```js
var onGlobalMessage = function (event) {
    if (
        (event.source === global || global.__POWERED_BY_QIANKUN__) &&
        typeof event.data === 'string' &&
        event.data.indexOf(messagePrefix) === 0
    ) {
        runIfPresent(+event.data.slice(messagePrefix.length))
    }
}
```

3. æœ€å, æ‰§è¡Œç¬¬ä¸€æ­¥è¿”å›çš„å‘½ä»¤: `pnpm patch-commit '/private/var/folders/0w/3bs237hx0_5bb5pk_tfqq5140000gn/T/1803a7b5a7b556da907c1199e582b295'` å³å¯,

æ­¤æ—¶, åœ¨é¡¹ç›®ç›®å½•ä¸‹å°±ä¼šæ–°å¢ä¸€ä¸ª `patches` æ–‡ä»¶å¤¹, é‡Œé¢æœ‰ `jszip@3.10.1.patch` æ–‡ä»¶, `package.json` ä¸­ä¹Ÿä¼šå¢åŠ ä»¥ä¸‹å†…å®¹:

```json
"pnpm": {
    "patchedDependencies": {
        "jszip@3.10.1": "patches/jszip@3.10.1.patch"
    }
}
```

è¿™æ ·, åœ¨åç»­çš„å®‰è£…ä¸­, éƒ½ä¼šè‡ªåŠ¨å®‰è£…è¿™ä¸ªè¡¥ä¸äº†, bug ä¹Ÿå°±éšä¹‹å®Œç¾è§£å†³ğŸ‰.

## æ€»ç»“

**çº¸ä¸Šå¾—æ¥ç»ˆè§‰æµ…, ç»çŸ¥æ­¤äº‹è¦èº¬è¡Œ.** è¯´ä¸€ç™¾éæ²™ç®±, éƒ½ä¸å¦‚å®å®åœ¨åœ¨çš„æ”¹ä¸€æ¬¡ bug ğŸ˜‚.

é¢å¤–åˆ†äº«ä¸¤ä¸ªæ‰“è¡¥ä¸çš„ç»éªŒ:

- å¯¹äº `Vite`, æ‰“å®Œè¡¥ä¸åé‡å¯å»è¦æ·»åŠ  `--force` å‘½ä»¤, å› ä¸º **Vite é¢„æ„å»º**, `node_modules` ä¸‹çš„`.vite` æ–‡ä»¶ä¼šæŠŠåŠ è½½çš„ä¾èµ–åšä¸€ä¸ªç¼“å­˜.
- æ’¤é”€è¡¥ä¸ä»…ä»…åˆ é™¤ `patches` æ–‡ä»¶å¤¹æ˜¯æ²¡æœ‰ç”¨çš„, éœ€è¦ `npx patch-package <pkgName@x>` å†é‡å¯.
  {/* - æ³¨æ„ä¸€ä¸‹ `package.json` ä¸­çš„å…¥å£æ–‡ä»¶æŒ‡å‘main module browseræ˜¯å¦æ˜¯è¦ä¿®æ”¹çš„æ–‡ä»¶. */}

[^1]: [qiankun 2.x è¿è¡Œæ—¶æ²™ç®±æºç åˆ†æ](https://www.cnblogs.com/liyongning/p/15867403.html)
